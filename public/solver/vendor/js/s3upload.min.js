function s3_upload(){var a=document.getElementById("status");new S3Upload({file_dom_selector:"id_attachment",s3_sign_put_url:"/attachments/sign_s3/",onProgress:function(b,c){$("#id_attachment").prop("disabled",!0),$("#id_attachment").prop("clicked",!0),a.innerHTML="Upload progress: "+b+"% "+c+'   <a class="cancel">Click to Cancel</a>',$('input[type="submit"]').prop("disabled",!0),$('input[type="submit"]').val("Still Uploading")},onFinishS3Put:function(b,c){$("<input>").attr({type:"hidden",id:"id_attachment"+String(att_counter)+"url",name:"attachment"+String(att_counter)+"url","class":"att_counter"+String(att_counter)}).appendTo("form"),$("#id_attachment"+String(att_counter)+"url").val(b),a.innerHTML="Upload completed for Attachment #"+String(att_counter),$("#inputboxattachment").append("<small class='att_counter"+String(att_counter)+"' class='name mid_gray_alt'>  Attachment: "+c+"&nbsp;&nbsp;<p class='close att_counter"+String(att_counter)+"'>x</p>  </small><br>"),att_counter++,$("#id_attachment").prop("disabled",!1),$('input[type="submit"]').prop("disabled",!1),$('input[type="submit"]').val("Finish")},onError:function(b){b.indexOf("403")>-1?a.innerHTML="Sorry, theres an error with your browser or your file. Try renaming the file, making sure it has an extension, or selecting individual files if it is a zip":a.innerHTML=b+" Please try again.",$("#id_attachment").prop("disabled",!1),$('input[type="submit"]').prop("disabled",!1),$('input[type="submit"]').val("Finish")}})}$(function(){$("#inputboxattachment").on("click","p.close",function(){var a=$(event.target).attr("class").replace("close ","");$(event.target.parentNode).remove(),$("."+a).remove()})}),function(){window.S3Upload=function(){function a(a){var b;null==a&&(a={});for(b in a)this[b]=a[b];this.handleFileSelect(document.getElementById(this.file_dom_selector))}return a.prototype.s3_object_name="default_name",a.prototype.s3_sign_put_url="/signS3put",a.prototype.file_dom_selector="file",a.prototype.with_credentials=!1,a.prototype.onFinishS3Put=function(a,b){return console.log("base.onFinishS3Put()",a,filename)},a.prototype.onProgress=function(a,b){return console.log("base.onProgress()",a,b)},a.prototype.onError=function(a){return console.log("base.onError()",a)},a.prototype.raiseCancel=function(){var a;return a=this,a.onError("Canceled")},a.prototype.handleFileSelect=function(a){var b,c,d,e,f;for(this.onProgress(0,"Upload started."),c=a.files,f=[],d=0,e=c.length;d<e;d++)b=c[d],f.push(this.uploadFile(b));return f},a.prototype.createCORSRequest=function(a,b){var c;return c=new XMLHttpRequest,null!=c.withCredentials?c.open(a,b,!0):"undefined"!=typeof XDomainRequest?(c=new XDomainRequest,c.open(a,b)):c=null,c},a.prototype.executeOnSignedUrl=function(a,b){var c,d;return c=this,d=new XMLHttpRequest,d.withCredentials=this.with_credentials,d.open("GET",this.s3_sign_put_url+"?s3_object_type="+a.type+"&s3_object_name="+a.name,!0),d.overrideMimeType("text/plain; charset=x-user-defined"),d.onreadystatechange=function(a){var d,e;if(4===this.readyState&&200===this.status){try{e=JSON.parse(this.responseText),console.log(e)}catch(f){return d=f,c.onError('Signing server returned some ugly/empty JSON: "'+this.responseText+'"'),!1}return b(decodeURIComponent(e.signed_request),e.url,e.mime_type)}if(4===this.readyState&&200!==this.status)return c.onError("Could not contact request signing server. Status = "+this.status)},d.send()},a.prototype.uploadToS3=function(a,b,c,d){var e,f;return e=this,f=this.createCORSRequest("PUT",b),f?(f.onload=function(){return 200===f.status?(e.onProgress(100,"Upload completed."),e.onFinishS3Put(c,String(a.name))):e.onError("Upload error: "+f.status)},f.onerror=function(){return e.onError("XHR error.")},f.upload.onprogress=function(a){var b;if($("#inputboxattachment").on("click","a.cancel",function(){return console.log("aborted"),f.abort(),e.onError("Canceled")}),a.lengthComputable)return b=Math.round(a.loaded/a.total*100),e.onProgress(b,100===b?"Finalizing.":"Uploading.")}):this.onError("CORS not supported"),f.setRequestHeader("Content-Type",d),f.setRequestHeader("x-amz-acl","public-read"),f.send(a)},a.prototype.uploadFile=function(a){var b;return b=this,this.executeOnSignedUrl(a,function(c,d,e){return b.uploadToS3(a,c,d,e)})},a}()}.call(this);